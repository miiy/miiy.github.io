---
layout: post
title: "Harbor"
date: 2020-12-12
tags: harbor
---

https://goharbor.io/

## Install

安装 docker, docker-compose

```bash
cd /usr/local/src
wget harbor-online-installer-v2.2.0.tgz
tar -zxvf harbor-online-installer-v2.2.0.tgz
mv harbor harbor-v2.2.0
mv harbor-v2.2.0 ../
cd ../
ln -s harbor-v2.2.0 harbor
```

生成证书

https://goharbor.io/docs/2.2.0/install-config/configure-https/

```bash

mkdir -p /data/harbor/certs
cd /data/harbor/harbor

openssl genrsa -out harbor.k8s.local.key 4096

openssl req -sha512 -new \
    -subj "/C=CN/ST=Beijing/L=Beijing/O=exampleOrg/CN=harbor.k8s.local" \
    -key harbor.k8s.local.key \
    -out harbor.k8s.local.csr

openssl x509 -req  -days 3650 \
    -in harbor.k8s.local.csr \
    -signkey harbor.k8s.local.key \
    -out harbor.k8s.local.crt
```

修改配置文件

```bash
cd /usr/local/harbor
cp harbor.yaml.tmpl harbor.yaml
vi harbor.yaml
```

```text
hostname: harbor.k8s.local

certificate: /data/harbor/certs/harbor.k8s.local.crt
private_key: /data/harbor/certs/harbor.k8s.local.key

data_volume: /data/harbor/data
```

安装

```bash
./install.sh
```

## 使用

```bash
vi /etc/hosts
```

```text
10.0.2.20       harbor.k8s.local
```

```bash
vi /etc/docker/daemon.json
{
    "registry-mirrors": ["http://hub-mirror.c.163.com"],
    "insecure-registries": ["https://harbor.k8s.local"]
}

systemctl restart docker

docker login -u admin harbor.k8s.local
```

在安装了 docker-compose 的机器上登录会报错，使用其他机器登录

```
Error saving credentials: error storing credentials - err: exit status 1, out: `Cannot autolaunch D-Bus w
```

```bash
root@debian:~# docker tag nginx:latest harbor.k8s.local/library/nginx:v1
root@debian:~# docker images
REPOSITORY                                           TAG           IMAGE ID       CREATED         SIZE
nginx                                                latest        6084105296a9   3 hours ago     133MB
harbor.k8s.local/library/nginx                       v1            6084105296a9   3 hours ago     133MB
root@k8s-node1:~# docker push harbor.k8s.local/library/nginx:v1
```

